#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "rb_tree.h"
#include "read_input.h"
#include "list_page.h"
#include "term.h"
#include "graph_page.h"
#include "stop_word_list.h"
#include "calculo_pr.h"
#include "search.h"

#include "../check_files.h"

#include <termios.h> 
#include <unistd.h>

int clear_icanon(void)
{
  struct termios settings;
  int result;
  result = tcgetattr (STDIN_FILENO, &settings);
  if (result < 0)
    {
      perror ("error in tcgetattr");
      return 0;
    }

  settings.c_lflag &= ~ICANON;

  result = tcsetattr (STDIN_FILENO, TCSANOW, &settings);
  if (result < 0)
    {
      perror ("error in tcsetattr");
      return 0;
   }
  return 1;
}

void catFilePath(char* dest, const char* dir, const char* file) {
    strcpy(dest, dir);
    strcat(dest, file);
}

int main(int argc, char** argv) {   
    //clear_icanon();

    char file_path[1000];
    
    const char* dir = argv[1];
    const char* index_filename = "/index.txt";
    catFilePath(file_path, dir, index_filename);
    tListPage* index = readIndex(file_path);    


    const char* stopwords_filename = "/stopwords.txt";
    catFilePath(file_path, dir, stopwords_filename);
    tRBT* stop_words = readStopWords(file_path);


    tRBT* terms = readTerm(index, stop_words, dir);

    destroyStopWords(stop_words);

    const int n_pages = sizeListPage(index);
    destroyListPage(index);

    const char* graph_filename = "/graph.txt";
    catFilePath(file_path, dir, graph_filename);
    tRBT* tree_graph= readGraph(file_path);

    calculatePageRank(tree_graph, n_pages);

    const char* line = "carried";
    const char* out = "./out_pr_sort.txt";
    FILE* out_file = fopen(out, "w");
    searchTermsFromLine(terms, tree_graph, line, out_file);
    fclose(out_file);

    const char* test[] = {"pages:19953-8.txt", "18400.txt", "28679-8.txt", "7194.txt", "26408-8.txt", "28396-8.txt", "25486.txt", "10473-8.txt", "11174.txt", "13881-0.txt", "1081.txt", "27286-8.txt", "12548-8.txt", "10494-8.txt", "261.txt", "27814.txt", "27711-8.txt", "27939-8.txt", "19811-8.txt", "2966.txt", "19489.txt", "1555.txt", "19254-0.txt", "19395-8.txt", "11159-8.txt", "7193.txt", "11498-8.txt", "23744-8.txt", "18964-8.txt", "7949-8.txt", "24310-8.txt", "16631.txt", "23661.txt", "108.txt", "11169-8.txt", "1480.txt", "27881-8.txt", "3356.txt", "16118-8.txt", "6391.txt", "22540.txt", "124.txt", "16284-8.txt", "19615.txt", "11540-8.txt", "19610.txt", "12090.txt", "27021-8.txt", "19194.txt", "24313-8.txt", "12416.txt", "20447.txt", "18834-0.txt", "21242.txt", "13548-8.txt", "51.txt", "13644-8.txt", "24347.txt", "18572-8.txt", "10337.txt", "12655-8.txt", "16520-8.txt", "21635.txt", "25604-0.txt", "29879-0.txt", "13899.txt", "11458-8.txt", "19487-0.txt", "17048-8.txt", "12732-8.txt", "5392.txt", "13877-8.txt", "27190-8.txt", "3597.txt", "23595-8.txt", "6023.txt", "12164.txt", "28135-8.txt", "25444.txt", "21508-8.txt", "28197.txt", "25295-8.txt", "29171.txt", "11009.txt", "23737.txt", "28987-8.txt", "1643.txt", "22127-8.txt", "11006.txt", "29468-8.txt", "28514-8.txt", "4149.txt", "16860-8.txt", "12810.txt", "24000-8.txt", "6191.txt", "17054.txt", "8800.txt", "4131.txt", "14759.txt", "1327.txt", "2523-8.txt", "245.txt", "10957-8.txt", "710.txt", "1487.txt", "27099-8.txt", "11623-8.txt", "28301-8.txt", "22959-8.txt", "29650-8.txt", "27631.txt", "17100-8.txt", "15171.txt", "30685-8.txt", "20195-8.txt", "29471.txt", "19087.txt", "13910.txt", "15506-8.txt", "22875.txt", "25088-8.txt", "23929.txt", "16691-8.txt", "24580-8.txt", "25061-8.txt", "5615-8.txt", "10479.txt", "18937.txt", "12336.txt", "29668-8.txt", "24856-8.txt", "12894-8.txt", "20473.txt", "21865-8.txt", "3888.txt", "2713-8.txt", "16808-8.txt", "21538.txt", "7529.txt", "11617-8.txt", "11573-8.txt", "13578-8.txt", "28066-0.txt", "16628-8.txt", "11323-8.txt", "29868-8.txt", "605.txt", "11404.txt", "12592-8.txt", "13778-8.txt", "25492-8.txt", "16354-8.txt", "29633-8.txt", "15025-8.txt", "26668-8.txt", "4153.txt", "14755-8.txt", "13342-8.txt", "23002-8.txt", "14488.txt", "19252-0.txt", "10027.txt", "10070.txt", "10325.txt", "10468.txt", "10986.txt", "11060.txt", "11094.txt", "11648-8.txt", "11735.txt", "11935.txt", "12175-8.txt", "12493.txt", "13444.txt", "14936-8.txt", "15436-8.txt", "15452-8.txt", "15563-8.txt", "15991-8.txt", "16098-8.txt", "16485-8.txt", "16505-8.txt", "17302-8.txt", "17462-8.txt", "18204-8.txt", "18548.txt", "19262-8.txt", "19277-0.txt", "19603-8.txt", "19852.txt", "20104-8.txt", "2086.txt", "21469.txt", "21842.txt", "21846-8.txt", "22088-8.txt", "23115.txt", "23138-8.txt", "23581-8.txt", "24469-8.txt", "24954-8.txt", "25302-8.txt", "25682-8.txt", "26013-8.txt", "26735-8.txt", "27341-8.txt", "27572-8.txt", "2791.txt", "27999-0.txt", "28073-0.txt", "28492-8.txt", "28744-0.txt", "28815-8.txt", "28859-8.txt", "28883.txt", "2893.txt", "29100-8.txt", "29463-8.txt", "3155-0.txt", "3469.txt", "3877.txt", "4704.txt", "5225.txt", "535.txt",
                          "pr:0.0116688951741296", "0.0116389426081307", "0.0102392467621183", "0.0101259954150938", "0.0096479258516750", "0.0093506864060048", "0.0091784718798282", "0.0091630606648563", "0.0090479003745319", "0.0089978315926931", "0.0087049733990094", "0.0085982728328608", "0.0085340821209749", "0.0082865197269535", "0.0082057216934445", "0.0080945190901772", "0.0079791987145067", "0.0079377635132121", "0.0076634881865955", "0.0074694008203361", "0.0072112516430598", "0.0071473520284300", "0.0067942899512140", "0.0067535576249401", "0.0061572696067651", "0.0061140397559510", "0.0060670720178207", "0.0060482627902725", "0.0058146979642057", "0.0056126251657154", "0.0055621867134771", "0.0055315327877869", "0.0055103366218544", "0.0052641975360103", "0.0052284897650514", "0.0051911062009128", "0.0051191194559135", "0.0050755139479376", "0.0049849962322210", "0.0047345800577843", "0.0046717844108890", "0.0046189131515189", "0.0045086450945551", "0.0041947967016513", "0.0041892450351445", "0.0041176504269167", "0.0040194084922593", "0.0038346968966022", "0.0037090313634284", "0.0036561990843020", "0.0036528796075850", "0.0035431606283961", "0.0035403866982599", "0.0033386944738664", "0.0032953086579599", "0.0029397305402584", "0.0029394252757425", "0.0029142959554194", "0.0028568030938666", "0.0027905050395172", "0.0025626435708364", "0.0025596439363075", "0.0023961265254917", "0.0023356775802828", "0.0022440695395601", "0.0022421668121909", "0.0021405189450316", "0.0021210509529397", "0.0019613446981982", "0.0019293029767032", "0.0017099577315968", "0.0016881679193139", "0.0016727666769757", "0.0016248980721270", "0.0015135989379966", "0.0014175250497098", "0.0013471434996769", "0.0013348975345381", "0.0013147133745462", "0.0013070210333528", "0.0012857151157359", "0.0012575841742737", "0.0012512378077960", "0.0012511172230029", "0.0012109078402331", "0.0011744707951640", "0.0011728923379302", "0.0011707996943711", "0.0011449111707422", "0.0010549118650159", "0.0010524769224991", "0.0010499759285756", "0.0009494129280726", "0.0008281775930337", "0.0007803241017928", "0.0007800885725508", "0.0007580153474143", "0.0007413347738517", "0.0007186680273585", "0.0007134947569292", "0.0006762374006266", "0.0006586667625484", "0.0006546090153689", "0.0006499194672597", "0.0006420139937419", "0.0006244428637631", "0.0006188422940172", "0.0006094824811284", "0.0005689895906366", "0.0005622267332373", "0.0005546417019130", "0.0005428494247365", "0.0005397104747687", "0.0005302242535800", "0.0005266729990877", "0.0004898324553618", "0.0004848202581314", "0.0004820060650975", "0.0004768260059014", "0.0004575514875020", "0.0004561306718734", "0.0004450604679519", "0.0004439048168783", "0.0004392855999596", "0.0004388773382355", "0.0004378398270216", "0.0004298849214037", "0.0004298487547798", "0.0004252573756970", "0.0004218578510343", "0.0004200207734054", "0.0003981650335629", "0.0003877398706334", "0.0003835508286979", "0.0003799913816040", "0.0003793206000925", "0.0003777455455871", "0.0003772566376469", "0.0003757356309414", "0.0003756249476681", "0.0003725966003597", "0.0003644212790542", "0.0003630275618994", "0.0003524566247644", "0.0003483676808976", "0.0003467891529370", "0.0003455156132488", "0.0003392724058663", "0.0003282049198376", "0.0003278785173520", "0.0003239541376265", "0.0003225688897325", "0.0003193156609080", "0.0003115165100789", "0.0003094821713636", "0.0003093900160302", "0.0003083248795474", "0.0003063979193537", "0.0003039230891099", "0.0003038059823282", "0.0003037500121751", "0.0003036956643454", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209", "0.0003000000119209",
                         };
    const int num = 450;
    check_file(out, test, num);

    destroyTerms(terms);
    destroyTreeGraphPage(tree_graph);

    return (EXIT_SUCCESS);
} 
 